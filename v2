<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ΑΑΔΕ QR Code Generator με Σύγκριση</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
        }

        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            background: #e9ecef;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .tab.active {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .step {
            margin: 25px 0;
            padding: 20px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transition: all 0.3s ease;
        }

        .step:hover {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .step-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .step-number {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-weight: bold;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            font-weight: 600;
            color: #495057;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .required::after {
            content: "*";
            color: #e74c3c;
        }

        .input-group input, .input-group textarea {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus, .input-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            border-left: 4px solid #667eea;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
        }

        .qr-container {
            display: flex;
            gap: 30px;
            align-items: flex-start;
            margin-top: 20px;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .url-section {
            flex: 1;
        }

        .final-result {
            background: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 30px;
        }

        .copy-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s ease;
            font-weight: 600;
        }

        .copy-btn:hover {
            background: #5a6fd8;
        }

        .load-example-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 0;
            font-weight: 600;
            width: 100%;
        }

        .load-example-btn:hover {
            background: #218838;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #28a745;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #dc3545;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #17a2b8;
        }

        .comparison-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin: 20px 0;
        }

        .comparison-side {
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            padding: 20px;
            background: #f8f9fa;
        }

        .comparison-side h3 {
            margin-top: 0;
            color: #2c3e50;
            text-align: center;
            padding: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 8px;
        }

        .diff-highlight {
            background: #ffeaa7 !important;
            padding: 2px 4px;
            border-radius: 4px;
            font-weight: bold;
        }

        .diff-new {
            background: #d4edda !important;
            color: #155724;
        }

        .diff-removed {
            background: #f8d7da !important;
            color: #721c24;
        }

        .comparison-results {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 2px solid #667eea;
        }

        .json-upload {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .json-upload:hover {
            background: #f8f9fa;
            border-color: #5a6fd8;
        }

        .json-upload.dragover {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .file-input {
            display: none;
        }

        .upload-text {
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            color: #6c757d;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 ΑΑΔΕ QR Code Generator με Σύγκριση</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('manual')">📝 Δημιουργία QR Code</div>
            <div class="tab" onclick="switchTab('json')">📁 JSON Upload</div>
            <div class="tab" onclick="switchTab('compare')">⚖️ Σύγκριση QR Codes</div>
        </div>

        <!-- Manual Input Tab -->
        <div id="manual-tab" class="tab-content active">
            <div class="step">
                <div class="step-title">
                    <div class="step-number">💡</div>
                    Φόρτωση Έτοιμου Παραδείγματος
                </div>
                <button class="load-example-btn" onclick="loadRealExample()">
                    🚀 Φόρτωση Παραδείγματος από το JSON σας (ΤΔΑ-260028375)
                </button>
                <div class="info">
                    <strong>📋 Στοιχεία Παραδείγματος:</strong> Εκδότης: EL154697391 | Λήπτης: DEMO Customer | Σειρά: ΤΔΑ | Αριθμός: 260028375 | Ποσό: 3120€
                </div>
            </div>

            <div class="step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Εισαγωγή Στοιχείων Παραστατικού
                </div>
                
                <div class="input-grid">
                    <div class="input-group">
                        <label class="required">IssuerTin (ΑΦΜ Εκδότη):</label>
                        <input type="text" id="issuerTin" value="EL154697391" placeholder="π.χ. EL154697391">
                    </div>
                    
                    <div class="input-group">
                        <label>CustomerTin (ΑΦΜ Λήπτη):</label>
                        <input type="text" id="customerTin" value="EL110099934" placeholder="Κενό για B2C">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">CustomerName (Όνομα Λήπτη):</label>
                        <input type="text" id="customerName" value="DEMO Customer" placeholder="π.χ. DEMO Customer">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">InvoiceType (Τύπος Παραστατικού):</label>
                        <input type="text" id="invoiceType" value="1.1" placeholder="π.χ. 1.1">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">Series (Σειρά):</label>
                        <input type="text" id="series" value="ΤΔΑ" placeholder="π.χ. ΤΔΑ">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">Number (Αριθμός):</label>
                        <input type="text" id="number" value="260028375" placeholder="π.χ. 260028375">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">DateIssued (Ημερομηνία Έκδοσης):</label>
                        <input type="datetime-local" id="dateIssued" value="2025-06-21T10:13:02">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">TotalAmount (Συνολικό Ποσό):</label>
                        <input type="number" id="totalAmount" value="3120" step="0.01" placeholder="π.χ. 3120">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">TotalNetAmount (Καθαρή Αξία):</label>
                        <input type="number" id="totalNetAmount" value="3120" step="0.01" placeholder="π.χ. 3120">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">TotalVatAmount (ΦΠΑ):</label>
                        <input type="number" id="totalVatAmount" value="0" step="0.01" placeholder="π.χ. 0">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">InternalId (Εσωτερικό ID):</label>
                        <input type="text" id="internalId" value="ΤΔΑX3752025-06-21 10:13:02" placeholder="π.χ. ΤΔΑX3752025-06-21 10:13:02">
                    </div>
                    
                    <div class="input-group">
                        <label class="required">ApiSecretKey:</label>
                        <input type="text" id="apiSecretKey" value="03ac2ca0-2815-41eb-894f-9d3a80c6c9da" placeholder="API Secret Key">
                    </div>
                </div>
            </div>

            <div class="step">
                <div class="step-title">
                    <div class="step-number">2</div>
                    Υπολογισμός Signature
                </div>
                <div class="output" id="signatureCalculation"></div>
            </div>

            <div class="step">
                <div class="step-title">
                    <div class="step-number">3</div>
                    Δημιουργία Offline QR Code URL
                </div>
                <div class="qr-container">
                    <div class="url-section">
                        <div class="output" id="generatedUrl"></div>
                        <button class="copy-btn" onclick="copyUrl()">📋 Αντιγραφή URL</button>
                        <button class="copy-btn" onclick="downloadQR('main')">💾 Download QR</button>
                        <button class="copy-btn" onclick="saveForComparison('A')" style="background: #dc3545;">💾 Αποθήκευση για Σύγκριση A</button>
                    </div>
                    <div class="qr-code">
                        <div style="margin-bottom: 15px; font-weight: bold;">QR Code:</div>
                        <canvas id="qrCanvas"></canvas>
                    </div>
                </div>
            </div>

            <div class="final-result">
                <div style="text-align: center;">
                    <strong>🎯 ΈΤΟΙΜΟ OFFLINE QR CODE!</strong>
                    <div style="margin-top: 15px;">
                        <button class="copy-btn" onclick="copyUrl()" style="background: rgba(255,255,255,0.2);">📋 Αντιγραφή URL</button>
                        <button class="copy-btn" onclick="downloadQR('main')" style="background: rgba(255,255,255,0.2);">💾 Download QR Code</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Upload Tab -->
        <div id="json-tab" class="tab-content">
            <div class="step">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Upload JSON Αρχείο
                </div>
                
                <div class="json-upload" id="jsonUpload">
                    <div class="upload-text">📁 Σύρετε και αφήστε το JSON αρχείο εδώ</div>
                    <div class="upload-subtext">ή κάντε κλικ για επιλογή αρχείου</div>
                    <input type="file" id="fileInput" class="file-input" accept=".json" />
                    
                    <div style="margin-top: 20px;">
                        <button class="copy-btn" onclick="loadDemoData()" style="background: #28a745;">
                            🚀 Δοκιμή με Demo JSON (Σύνθετη ΑΑΔΕ Δομή)
                        </button>
                    </div>
                </div>

                <div class="info">
                    <strong>🤖 Υποστηριζόμενα JSON Formats:</strong>
                    
                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; font-weight: bold; color: #667eea;">📋 Απλό JSON Format</summary>
                        <pre style="margin: 10px 0; font-size: 11px; background: #f1f3f4; padding: 10px; border-radius: 5px;">{
  "issuerTin": "EL154697391",
  "customerTin": "EL110099934", 
  "customerName": "DEMO Customer",
  "invoiceType": "1.1",
  "series": "ΤΔΑ",
  "number": "260028375",
  "dateIssued": "2025-06-21T10:13:02",
  "totalAmount": 3120,
  "totalNetAmount": 3120,
  "totalVatAmount": 0,
  "internalId": "ΤΔΑX3752025-06-21 10:13:02",
  "apiSecretKey": "03ac2ca0-2815-41eb-894f-9d3a80c6c9da"
}</pre>
                    </details>

                    <details style="margin: 15px 0;">
                        <summary style="cursor: pointer; font-weight: bold; color: #667eea;">🏢 Σύνθετο ΑΑΔΕ JSON Format</summary>
                        <pre style="margin: 10px 0; font-size: 11px; background: #f1f3f4; padding: 10px; border-radius: 5px;">{
  "APIKEY": "03ac2ca0-2815-41eb-894f-9d3a80c6c9da",
  "InvoiceTypeCode": "1.1",
  "Series": "ΤΔΑ", 
  "Number": "260028375",
  "DateIssued": "2025-06-21T10:13:02",
  "Issuer": { "Vat": "EL154697391" },
  "CounterParty": {
    "RegisteredName": "DEMO Customer",
    "Vat": "EL110099934"
  },
  "DistributionDetails": {
    "InternalDocumentId": "ΤΔΑX3752025-06-21 10:13:02"
  },
  "Summaries": {
    "TotalPayableAmount": 3120,
    "TotalNetAmount": 3120,
    "TotalVATAmount": 0
  }
}</pre>
                    </details>

                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 15px;">
                        <strong>💡 Smart Analysis:</strong> Το σύστημα αναγνωρίζει αυτόματα τη δομή του JSON και εντοπίζει τα υποχρεωτικά πεδία!
                    </div>
                </div>
            </div>
        </div>

        <!-- Comparison Tab -->
        <div id="compare-tab" class="tab-content">
            <div class="step">
                <div class="step-title">
                    <div class="step-number">⚖️</div>
                    Σύγκριση Offline QR Codes
                </div>
                
                <div class="comparison-container">
                    <div class="comparison-side">
                        <h3>🅰️ QR Code A</h3>
                        <div class="input-group">
                            <label>URL ή Data A:</label>
                            <textarea id="compareDataA" rows="8" placeholder="Επικολλήστε εδώ το URL ή τα στοιχεία του QR Code A..."></textarea>
                        </div>
                        <button class="copy-btn" onclick="parseQRData('A')" style="background: #17a2b8; width: 100%;">🔍 Ανάλυση Data A</button>
                        <div class="qr-code" style="margin-top: 15px;">
                            <canvas id="qrCanvasA" style="max-width: 200px;"></canvas>
                        </div>
                    </div>
                    
                    <div class="comparison-side">
                        <h3>🅱️ QR Code B</h3>
                        <div class="input-group">
                            <label>URL ή Data B:</label>
                            <textarea id="compareDataB" rows="8" placeholder="Επικολλήστε εδώ το URL ή τα στοιχεία του QR Code B..."></textarea>
                        </div>
                        <button class="copy-btn" onclick="parseQRData('B')" style="background: #17a2b8; width: 100%;">🔍 Ανάλυση Data B</button>
                        <div class="qr-code" style="margin-top: 15px;">
                            <canvas id="qrCanvasB" style="max-width: 200px;"></canvas>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button class="copy-btn" onclick="compareQRCodes()" style="background: #e74c3c; font-size: 18px; padding: 15px 30px;">
                        ⚖️ ΣΥΓΚΡΙΣΗ QR CODES
                    </button>
                    <button class="copy-btn" onclick="loadExampleComparison()" style="background: #f39c12;">
                        📋 Φόρτωση Παραδείγματος Σύγκρισης
                    </button>
                </div>

                <div id="comparisonResults"></div>
            </div>
        </div>
    </div>

    <script>
        let currentUrl = '';
        let savedComparisons = { A: null, B: null };
        let parsedDataA = null;
        let parsedDataB = null;

        function switchTab(tab) {
            // Remove active class from all tabs and contents
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Add active class to selected tab and content
            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');
        }

        async function calculateSignature() {
            try {
                // Συλλογή δεδομένων
                const issuerTin = document.getElementById('issuerTin').value;
                const customerTin = document.getElementById('customerTin').value;
                const customerName = document.getElementById('customerName').value;
                const invoiceType = document.getElementById('invoiceType').value;
                const series = document.getElementById('series').value;
                const number = document.getElementById('number').value;
                const dateIssued = document.getElementById('dateIssued').value;
                const totalAmount = document.getElementById('totalAmount').value;
                const totalNetAmount = document.getElementById('totalNetAmount').value;
                const totalVatAmount = document.getElementById('totalVatAmount').value;
                const internalId = document.getElementById('internalId').value;
                const apiSecretKey = document.getElementById('apiSecretKey').value;

                // Μετατροπή ημερομηνίας σε yyyyMMddHHmmss format
                const date = new Date(dateIssued);
                const formattedDate = date.getFullYear().toString() +
                                     (date.getMonth() + 1).toString().padStart(2, '0') +
                                     date.getDate().toString().padStart(2, '0') +
                                     date.getHours().toString().padStart(2, '0') +
                                     date.getMinutes().toString().padStart(2, '0') +
                                     date.getSeconds().toString().padStart(2, '0');

                // Δημιουργία signature string
                const signatureInput = `${issuerTin}-${customerTin}-${series}-${number}-${formattedDate}-${totalAmount}-${internalId}`;
                const stringWithSalt = signatureInput + apiSecretKey;

                // SHA1 Hash
                const encoder = new TextEncoder();
                const utf8Bytes = encoder.encode(stringWithSalt);
                const hashBuffer = await crypto.subtle.digest('SHA-1', utf8Bytes);
                const hashArray = new Uint8Array(hashBuffer);
                const signature = Array.from(hashArray)
                    .map(byte => byte.toString(16).padStart(2, '0'))
                    .join('');

                document.getElementById('signatureCalculation').innerHTML = `
                    <strong>Input String:</strong> ${signatureInput}<br>
                    <strong>With Salt:</strong> ${stringWithSalt}<br>
                    <strong>SHA1 Signature:</strong> ${signature}
                `;

                // Δημιουργία URL
                const baseUrl = 'https://einvoiceportaluat.impact.gr/TransmissionFailure';
                const params = new URLSearchParams({
                    IssuerTin: issuerTin,
                    CustomerTin: customerTin,
                    CustomerName: customerName,
                    InvoiceType: invoiceType,
                    Series: series,
                    Number: number,
                    DateIssued: formattedDate,
                    TotalAmount: totalAmount,
                    TotalNetAmount: totalNetAmount,
                    TotalVatAmount: totalVatAmount,
                    InternalId: internalId,
                    Signature: signature
                });

                currentUrl = `${baseUrl}?${params.toString()}`;
                document.getElementById('generatedUrl').textContent = currentUrl;

                // Δημιουργία QR Code
                await generateQRCode(currentUrl, 'qrCanvas');

            } catch (error) {
                console.error('Error:', error);
                document.getElementById('signatureCalculation').innerHTML = `<span style="color: red;">Σφάλμα: ${error.message}</span>`;
            }
        }

        async function generateQRCode(url, canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            try {
                await QRCode.toCanvas(canvas, url, {
                    width: canvasId.includes('Canvas') && !canvasId.includes('main') ? 200 : 256,
                    margin: 2,
                    color: {
                        dark: '#000000',
                        light: '#FFFFFF'
                    }
                });
            } catch (error) {
                console.error('QR Code generation error:', error);
            }
        }

        function copyUrl() {
            navigator.clipboard.writeText(currentUrl).then(() => {
                showNotification('✅ URL αντιγράφηκε στο clipboard!', 'success');
            }).catch(err => {
                showNotification('❌ Σφάλμα κατά την αντιγραφή', 'error');
            });
        }

        function downloadQR(type = 'main') {
            const canvasId = type === 'main' ? 'qrCanvas' : `qrCanvas${type.toUpperCase()}`;
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            const link = document.createElement('a');
            link.download = `qr-code-${type}.png`;
            link.href = canvas.toDataURL();
            link.click();
            showNotification(`💾 QR Code ${type} έγινε download!`, 'success');
        }

        function saveForComparison(slot) {
            if (!currentUrl) {
                showNotification('❌ Δεν υπάρχει QR Code για αποθήκευση', 'error');
                return;
            }
            
            savedComparisons[slot] = {
                url: currentUrl,
                data: getCurrentFormData()
            };
            showNotification(`✅ QR Code αποθηκεύτηκε στη θέση ${slot}`, 'success');
        }

        function getCurrentFormData() {
            return {
                issuerTin: document.getElementById('issuerTin').value,
                customerTin: document.getElementById('customerTin').value,
                customerName: document.getElementById('customerName').value,
                invoiceType: document.getElementById('invoiceType').value,
                series: document.getElementById('series').value,
                number: document.getElementById('number').value,
                dateIssued: document.getElementById('dateIssued').value,
                totalAmount: document.getElementById('totalAmount').value,
                totalNetAmount: document.getElementById('totalNetAmount').value,
                totalVatAmount: document.getElementById('totalVatAmount').value,
                internalId: document.getElementById('internalId').value,
                apiSecretKey: document.getElementById('apiSecretKey').value
            };
        }

        function parseQRData(slot) {
            const textarea = document.getElementById(`compareData${slot}`);
            const data = textarea.value.trim();
            
            if (!data) {
                showNotification(`❌ Εισάγετε δεδομένα για το QR Code ${slot}`, 'error');
                return;
            }

            try {
                let parsedData = {};
                
                if (data.startsWith('http')) {
                    // Parse URL parameters
                    const url = new URL(data);
                    const params = new URLSearchParams(url.search);
                    
                    parsedData = {
                        IssuerTin: params.get('IssuerTin') || '',
                        CustomerTin: params.get('CustomerTin') || '',
                        CustomerName: params.get('CustomerName') || '',
                        InvoiceType: params.get('InvoiceType') || '',
                        Series: params.get('Series') || '',
                        Number: params.get('Number') || '',
                        DateIssued: params.get('DateIssued') || '',
                        TotalAmount: params.get('TotalAmount') || '',
                        TotalNetAmount: params.get('TotalNetAmount') || '',
                        TotalVatAmount: params.get('TotalVatAmount') || '',
                        InternalId: params.get('InternalId') || '',
                        Signature: params.get('Signature') || ''
                    };
                } else {
                    // Try to parse as JSON
                    parsedData = JSON.parse(data);
                }

                if (slot === 'A') {
                    parsedDataA = parsedData;
                } else {
                    parsedDataB = parsedData;
                }

                // Generate QR code for comparison
                generateQRCode(data, `qrCanvas${slot}`);
                
                showNotification(`✅ Δεδομένα ${slot} αναλύθηκαν επιτυχώς`, 'success');

            } catch (error) {
                showNotification(`❌ Σφάλμα ανάλυσης δεδομένων ${slot}: ${error.message}`, 'error');
            }
        }

        function compareQRCodes() {
            if (!parsedDataA || !parsedDataB) {
                showNotification('❌ Παρακαλώ αναλύστε πρώτα και τα δύο QR Codes', 'error');
                return;
            }

            const comparison = generateComparison(parsedDataA, parsedDataB);
            displayComparisonResults(comparison);
        }

        function generateComparison(dataA, dataB) {
            const allKeys = new Set([...Object.keys(dataA), ...Object.keys(dataB)]);
            const differences = [];
            const similarities = [];

            allKeys.forEach(key => {
                const valueA = dataA[key];
                const valueB = dataB[key];

                if (valueA !== valueB) {
                    differences.push({
                        field: key,
                        valueA: valueA || 'N/A',
                        valueB: valueB || 'N/A'
                    });
                } else {
                    similarities.push({
                        field: key,
                        value: valueA
                    });
                }
            });

            return { differences, similarities };
        }

        function displayComparisonResults(comparison) {
            const resultsDiv = document.getElementById('comparisonResults');
            
            const differencesHtml = comparison.differences.length > 0 ? 
                comparison.differences.map(diff => `
                    <tr>
                        <td style="padding: 8px; font-weight: bold;">${diff.field}</td>
                        <td style="padding: 8px; background: #f8d7da; color: #721c24;">${diff.valueA}</td>
                        <td style="padding: 8px; background: #d4edda; color: #155724;">${diff.valueB}</td>
                    </tr>
                `).join('') : '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #28a745;">✅ Δεν βρέθηκαν διαφορές!</td></tr>';

            const similaritiesHtml = comparison.similarities.length > 0 ?
                comparison.similarities.map(sim => `
                    <tr>
                        <td style="padding: 8px; font-weight: bold;">${sim.field}</td>
                        <td style="padding: 8px;" colspan="2">${sim.value}</td>
                    </tr>
                `).join('') : '<tr><td colspan="3" style="text-align: center; padding: 20px;">Δεν υπάρχουν ομοιότητες</td></tr>';

            resultsDiv.innerHTML = `
                <div class="comparison-results">
                    <h3 style="color: #e74c3c; margin-top: 0;">⚠️ Διαφορές (${comparison.differences.length})</h3>
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Πεδίο</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">QR Code A</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">QR Code B</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${differencesHtml}
                        </tbody>
                    </table>

                    <h3 style="color: #28a745; margin-top: 0;">✅ Ομοιότητες (${comparison.similarities.length})</h3>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: #f8f9fa;">
                                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;">Πεδίο</th>
                                <th style="padding: 10px; text-align: left; border: 1px solid #dee2e6;" colspan="2">Αξία</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${similaritiesHtml}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function loadExampleComparison() {
            // Load two slightly different examples for comparison
            const dataA = "https://einvoiceportaluat.impact.gr/TransmissionFailure?IssuerTin=EL154697391&CustomerTin=EL110099934&CustomerName=DEMO+Customer&InvoiceType=1.1&Series=%CE%A4%CE%94%CE%91&Number=260028375&DateIssued=20250621101302&TotalAmount=3120&TotalNetAmount=3120&TotalVatAmount=0&InternalId=%CE%A4%CE%94%CE%91X3752025-06-21+10%3A13%3A02&Signature=abcdef123456";
            
            const dataB = "https://einvoiceportaluat.impact.gr/TransmissionFailure?IssuerTin=EL154697391&CustomerTin=EL110099934&CustomerName=DEMO+Customer&InvoiceType=1.1&Series=%CE%A4%CE%94%CE%91&Number=260028376&DateIssued=20250621101302&TotalAmount=3150&TotalNetAmount=3150&TotalVatAmount=0&InternalId=%CE%A4%CE%94%CE%91X3752025-06-21+10%3A13%3A02&Signature=fedcba654321";

            document.getElementById('compareDataA').value = dataA;
            document.getElementById('compareDataB').value = dataB;

            parseQRData('A');
            parseQRData('B');

            showNotification('📋 Παράδειγμα σύγκρισης φορτώθηκε!', 'success');
        }

        function loadRealExample() {
            // Load the real example from your JSON
            document.getElementById('issuerTin').value = "EL154697391";
            document.getElementById('customerTin').value = "EL110099934";
            document.getElementById('customerName').value = "DEMO Customer";
            document.getElementById('invoiceType').value = "1.1";
            document.getElementById('series').value = "ΤΔΑ";
            document.getElementById('number').value = "260028375";
            document.getElementById('dateIssued').value = "2025-06-21T10:13:02";
            document.getElementById('totalAmount').value = "3120";
            document.getElementById('totalNetAmount').value = "3120";
            document.getElementById('totalVatAmount').value = "0";
            document.getElementById('internalId').value = "ΤΔΑX3752025-06-21 10:13:02";
            document.getElementById('apiSecretKey').value = "03ac2ca0-2815-41eb-894f-9d3a80c6c9da";

            calculateSignature();
            showNotification('🚀 Έτοιμο παράδειγμα φορτώθηκε!', 'success');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = type;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.padding = '15px';
            notification.style.borderRadius = '8px';
            notification.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        // JSON Upload functionality
        function setupJsonUpload() {
            const uploadArea = document.getElementById('jsonUpload');
            const fileInput = document.getElementById('fileInput');

            if (!uploadArea || !fileInput) return;

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });

            fileInput.addEventListener('change', (e) => {
                handleFile(e.target.files[0]);
            });
        }

        function handleFile(file) {
            if (!file || !file.name.endsWith('.json')) {
                showNotification('❌ Παρακαλώ επιλέξτε ένα JSON αρχείο', 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const jsonData = JSON.parse(e.target.result);
                    populateFields(jsonData);
                    showNotification('✅ JSON αρχείο φορτώθηκε επιτυχώς!', 'success');
                    
                    // Switch to manual tab to show populated fields
                    switchTab('manual');
                    document.querySelector('.tab').classList.remove('active');
                    document.querySelectorAll('.tab')[0].classList.add('active');
                } catch (error) {
                    showNotification('❌ Μη έγκυρο JSON αρχείο', 'error');
                }
            };
            reader.readAsText(file);
        }

        function populateFields(data) {
            let extractedData = {};
            let analysisLog = [];

            // Smart JSON Analysis - Detect field structure automatically
            if (data.Issuer && data.CounterParty && data.Summaries) {
                // Complex ΑΑΔΕ JSON structure detected
                analysisLog.push("🔍 Ανιχνεύτηκε σύνθετη δομή ΑΑΔΕ JSON");
                
                extractedData = {
                    issuerTin: data.Issuer?.Vat || '',
                    customerTin: data.CounterParty?.Vat || '',
                    customerName: data.CounterParty?.RegisteredName || '',
                    invoiceType: data.InvoiceTypeCode || '',
                    series: data.Series || '',
                    number: data.Number || '',
                    dateIssued: data.DateIssued || '',
                    totalAmount: data.Summaries?.TotalPayableAmount || 0,
                    totalNetAmount: data.Summaries?.TotalNetAmount || 0,
                    totalVatAmount: data.Summaries?.TotalVATAmount || 0,
                    internalId: data.DistributionDetails?.InternalDocumentId || '',
                    apiSecretKey: data.APIKEY || ''
                };
            } else {
                // Simple direct mapping for basic JSON structure
                analysisLog.push("🔍 Ανιχνεύτηκε απλή δομή JSON");
                
                const fieldMap = {
                    'issuerTin': 'issuerTin',
                    'customerTin': 'customerTin',
                    'customerName': 'customerName',
                    'invoiceType': 'invoiceType',
                    'series': 'series',
                    'number': 'number',
                    'dateIssued': 'dateIssued',
                    'totalAmount': 'totalAmount',
                    'totalNetAmount': 'totalNetAmount',
                    'totalVatAmount': 'totalVatAmount',
                    'internalId': 'internalId',
                    'apiSecretKey': 'apiSecretKey'
                };

                Object.keys(fieldMap).forEach(field => {
                    if (data[field] !== undefined) {
                        extractedData[fieldMap[field]] = data[field];
                        analysisLog.push(`✅ ${field}: ${data[field]}`);
                    } else {
                        analysisLog.push(`❌ ${field}: NOT FOUND`);
                    }
                });
            }

            // Populate form fields
            Object.keys(extractedData).forEach(field => {
                const element = document.getElementById(field);
                if (element && extractedData[field] !== undefined && extractedData[field] !== '') {
                    element.value = extractedData[field];
                }
            });

            // Trigger calculation after populating fields
            setTimeout(calculateSignature, 100);
        }

        function loadDemoData() {
            const demoJsonData = {
                "APIKEY": "03ac2ca0-2815-41eb-894f-9d3a80c6c9da",
                "InvoiceTypeCode": "1.1",
                "Series": "ΤΔΑ",
                "Number": "260028375",
                "DateIssued": "2025-06-21T10:13:02",
                "Issuer": {
                    "Vat": "EL154697391"
                },
                "CounterParty": {
                    "RegisteredName": "DEMO Customer",
                    "Vat": "EL110099934"
                },
                "DistributionDetails": {
                    "InternalDocumentId": "ΤΔΑX3752025-06-21 10:13:02"
                },
                "Summaries": {
                    "TotalPayableAmount": 3120,
                    "TotalNetAmount": 3120,
                    "TotalVATAmount": 0
                }
            };

            populateFields(demoJsonData);
            showNotification('🚀 Demo δεδομένα φορτώθηκαν επιτυχώς!', 'success');
            
            // Switch to manual tab to show populated fields
            switchTab('manual');
            document.querySelector('.tab').classList.remove('active');
            document.querySelectorAll('.tab')[0].classList.add('active');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Setup JSON upload
            setupJsonUpload();
            
            // Add event listeners for real-time calculation
            const inputs = document.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', calculateSignature);
            });
            
            // Initial calculation
            calculateSignature();
        });
    </script>
</body>
</html>
